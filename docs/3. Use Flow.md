# Use Flow

## Огляд

Цей документ описує MVP-процес автентифікації користувача через Google OAuth 2.0 та отримання даних Google Analytics 4 (GA4) за допомогою офіційних API Google. Усі запити до GA4 та обробка даних виконуються виключно на бекенді.

## Учасники

- **Користувач**
- **Frontend (веб-застосунок)**
- **Backend (API сервер)**
- **Google OAuth 2.0**
- **Google Analytics Admin API**
- **Google Analytics Data API**
- **AI-сервіс (LLM)**

## 1. Автентифікація користувача (OAuth 2.0)

### 1.1 Ініціалізація логіну

- Користувач відкриває веб-застосунок.
- Користувач натискає кнопку **«Login with Google»**.
- Frontend редіректить користувача на сторінку авторизації Google OAuth 2.0 з параметрами:
  - `client_id`
  - `redirect_uri`
  - `response_type=code`
  - `scope=analytics.readonly`

### 1.2 Авторизація в Google

- Користувач обирає Google-акаунт.
- Користувач надає дозвіл на читання даних Google Analytics.

### 1.3 Callback з authorization code

- Google перенаправляє користувача на callback-ендпоінт бекенду:

```
GET /auth/google/callback?code=AUTHORIZATION_CODE
```

### 1.4 Обмін code на токени (Backend)

- Backend надсилає `AUTHORIZATION_CODE` на OAuth endpoint Google.
- Backend отримує:
  - `access_token`
  - `refresh_token`
  - `expires_in`

### 1.5 Створення сесії

- Backend створює внутрішню сесію користувача.
- Google-токени зберігаються безпечно на бекенді.
- Frontend отримує підтвердження авторизації (cookie або JWT).

## 2. Вибір GA4 property

### 2.1 Отримання списку property

- Backend викликає **Google Analytics Admin API** з використанням `access_token`.
- Backend отримує список GA4 property, доступних користувачу.

### 2.2 Вибір property

- Backend передає список GA4 property на frontend.
- Користувач обирає одну GA4 property для аналізу.
- Обраний `propertyId` зберігається для користувача.

## 3. Отримання даних GA4

### 3.1 Запит на звіт

- Frontend надсилає запит на backend:

```
GET /api/report?period=last_30_days
```

### 3.2 Запит до GA4 API (Backend)

- Backend використовує збережений `access_token`.
- Backend викликає **Google Analytics Data API**:

```
POST /v1beta/properties/{propertyId}:runReport
```

- Заголовок авторизації:

```
Authorization: Bearer ACCESS_TOKEN
```

### 3.3 Метрики

- Кількість користувачів
- Кількість сесій
- Кількість подій
- Конверсії
- Час залученості
- Джерела трафіку

### 3.4 Оновлення токена

- Якщо `access_token` протермінований:
  - Backend використовує `refresh_token`
  - Отримує новий `access_token`
  - Повторює запит до GA4 API

## 4. Обробка даних на бекенді

### 4.1 Агрегація

- Сирі дані GA4 агрегуються на бекенді.
- Формуються підсумкові значення метрик за вибраний період.
- Обчислюються зміни відносно попереднього періоду (за наявності).

### 4.2 Аналітичний зріз

- Backend формує структурований аналітичний звіт:
  - ключові значення метрик
  - відсоткові зміни
  - виявлені тренди (зростання / падіння)

## 5. AI-аналіз (MVP)

### 5.1 Вхідні дані для AI

- Backend передає до AI-сервісу лише структурований аналітичний зріз.
- Сирі дані GA4 не передаються.

### 5.2 Результат AI

- AI генерує:
  - текстові інсайти
  - пояснення змін
  - базові рекомендації

## 6. Відображення результатів

### 6.1 Відповідь API

- Backend повертає frontend:
  - агреговані метрики
  - AI-звіт

### 6.2 Інтерфейс користувача

- Frontend відображає:
  - спрощений дашборд
  - текстовий AI-звіт
- Frontend не виконує прямих запитів до GA4 API.

## 7. Обмеження безпеки (MVP)

- `access_token` та `refresh_token` Google ніколи не передаються на frontend.
- Усі запити до GA4 виконуються виключно на бекенді.
- Frontend взаємодіє лише з backend API.
